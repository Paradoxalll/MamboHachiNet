<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - MamboHachimi</title>
    <link rel="icon" type="image/png" href="./mambohachimilogo.png">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            width: 95%;
            margin: 100px auto 50px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .admin-header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .admin-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .admin-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .admin-section h2 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(78, 237, 196, 0.15);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid rgba(78, 237, 196, 0.3);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .user-list, .message-list {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }

        .user-item, .message-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info, .message-info {
            color: white;
            flex: 1;
        }

        .user-email {
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .user-details {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .delete-btn {
            padding: 8px 16px;
            background: rgba(255, 100, 100, 0.3);
            border: 2px solid rgba(255, 100, 100, 0.5);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .delete-btn:hover {
            background: rgba(255, 100, 100, 0.5);
            transform: scale(1.05);
        }

        .ban-btn {
            padding: 8px 16px;
            background: rgba(255, 150, 0, 0.3);
            border: 2px solid rgba(255, 150, 0, 0.5);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin-right: 10px;
        }

        .ban-btn:hover {
            background: rgba(255, 150, 0, 0.5);
            transform: scale(1.05);
        }

        .access-denied {
            text-align: center;
            color: white;
            padding: 60px;
        }

        .access-denied h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .search-box {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .refresh-btn {
            padding: 12px 24px;
            background: rgba(78, 237, 196, 0.2);
            border: 2px solid rgba(78, 237, 196, 0.6);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: rgba(78, 237, 196, 0.4);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- User Menu -->
    <div class="user-menu">
        <button class="user-menu-btn" id="userMenuBtn">
            <span id="userMenuText">Account</span>
            <span>‚ñº</span>
        </button>
        <div class="user-menu-dropdown" id="userMenuDropdown">
            <div class="user-email-display" id="userEmailDisplay" style="display: none;"></div>
            <a href="login.html" class="user-menu-item" id="loginLink">üîë Login</a>
            <a href="admin-login.html" class="user-menu-item" id="adminLoginLink">üõ°Ô∏è Admin Login</a>
            <div class="user-menu-divider" id="logoutDivider" style="display: none;"></div>
            <div class="user-menu-item" id="logoutLink" style="display: none;">üö™ Logout</div>
        </div>
    </div>

    <nav>
        <a href="index.html">Home</a>
        <a href="about.html">About Us</a>
        <a href="forum.html">Forum</a>
        <a href="login.html">Login</a>
    </nav>

    <div class="admin-container" id="accessDenied" style="display: none;">
        <div class="access-denied">
            <h1>üö´ Access Denied</h1>
            <p>You do not have permission to access this page.</p>
            <p><a href="admin-login.html" style="color: #4ecdc4;">Go to Admin Login</a></p>
        </div>
    </div>

    <div class="admin-container" id="adminPanel" style="display: none;">
        <div class="admin-header">
            <h1>üõ°Ô∏è Admin Portal</h1>
            <p>Welcome, <span id="adminName"></span></p>
        </div>

        <div class="admin-section">
            <h2>üìä Site Analytics</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Total Messages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="messagesLast24h">0</div>
                    <div class="stat-label">Messages (24h)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
            </div>
            <button class="refresh-btn" onclick="loadAnalytics()">üîÑ Refresh Stats</button>
        </div>

        <div class="admin-section">
            <h2>üë• User Management</h2>
            <input type="text" class="search-box" id="userSearch" placeholder="Search users by email or display name...">
            <div class="user-list" id="userList"></div>
        </div>

        <div class="admin-section">
            <h2>üí¨ Recent Messages</h2>
            <input type="text" class="search-box" id="messageSearch" placeholder="Search messages...">
            <div class="message-list" id="messageList"></div>
        </div>

        <div class="admin-section">
            <h2>üö´ Blacklist Management</h2>
            <input type="text" class="search-box" id="newBlacklistWord" placeholder="Add word to blacklist...">
            <button class="refresh-btn" onclick="addBlacklistWord()">‚ûï Add Word</button>
            <div class="user-list" id="blacklistList"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const ADMIN_EMAILS = [
            'prddux0001@gmail.com',
            'fumohachimi@gmail.com'
        ];

        let allUsers = [];
        let allMessages = [];

        auth.onAuthStateChanged((user) => {
            if (user && ADMIN_EMAILS.includes(user.email)) {
                document.getElementById('accessDenied').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminName').textContent = user.email;
                loadAnalytics();
                loadUsers();
                loadMessages();
                loadBlacklist();

                // Update menu
                document.getElementById('userMenuText').textContent = user.email.split('@')[0];
                document.getElementById('userEmailDisplay').textContent = user.email;
                document.getElementById('userEmailDisplay').style.display = 'block';
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('logoutDivider').style.display = 'block';
                document.getElementById('logoutLink').style.display = 'block';
            } else {
                document.getElementById('accessDenied').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';

                // Update menu
                if (user) {
                    document.getElementById('userMenuText').textContent = user.email.split('@')[0];
                    document.getElementById('userEmailDisplay').textContent = user.email;
                    document.getElementById('userEmailDisplay').style.display = 'block';
                    document.getElementById('loginLink').style.display = 'none';
                    document.getElementById('logoutDivider').style.display = 'block';
                    document.getElementById('logoutLink').style.display = 'block';
                } else {
                    document.getElementById('userMenuText').textContent = 'Account';
                    document.getElementById('userEmailDisplay').style.display = 'none';
                    document.getElementById('loginLink').style.display = 'block';
                    document.getElementById('logoutDivider').style.display = 'none';
                    document.getElementById('logoutLink').style.display = 'none';
                }
            }
        });

        function loadAnalytics() {
            database.ref('users').once('value', (snapshot) => {
                const users = snapshot.val();
                const userCount = users ? Object.keys(users).length : 0;
                document.getElementById('totalUsers').textContent = userCount;
            });

            database.ref('messages').once('value', (snapshot) => {
                const messages = snapshot.val();
                const messageCount = messages ? Object.keys(messages).length : 0;
                document.getElementById('totalMessages').textContent = messageCount;

                const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
                let recentCount = 0;
                if (messages) {
                    Object.values(messages).forEach(msg => {
                        if (msg.timestamp > oneDayAgo) {
                            recentCount++;
                        }
                    });
                }
                document.getElementById('messagesLast24h').textContent = recentCount;

                const activeUserIds = new Set();
                if (messages) {
                    Object.values(messages).forEach(msg => {
                        if (msg.timestamp > oneDayAgo) {
                            activeUserIds.add(msg.userId);
                        }
                    });
                }
                document.getElementById('activeUsers').textContent = activeUserIds.size;
            });
        }

        function loadUsers() {
            database.ref('users').once('value', (snapshot) => {
                const users = snapshot.val();
                allUsers = [];
                if (users) {
                    Object.keys(users).forEach(uid => {
                        allUsers.push({ uid: uid, ...users[uid] });
                    });
                }
                displayUsers(allUsers);
            });
        }

        function displayUsers(users) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            if (users.length === 0) {
                userList.innerHTML = '<p style="color: white; text-align: center;">No users found</p>';
                return;
            }
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-email">${user.email}</div>
                        <div class="user-details">Display Name: ${user.displayName || 'N/A'}</div>
                        <div class="user-details">UID: ${user.uid}</div>
                    </div>
                    <div>
                        <button class="ban-btn" onclick="banUser('${user.uid}', '${user.email}')">üö´ Ban</button>
                        <button class="delete-btn" onclick="deleteUser('${user.uid}')">üóëÔ∏è Delete</button>
                    </div>
                `;
                userList.appendChild(userItem);
            });
        }

        document.getElementById('userSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm) ||
                (user.displayName && user.displayName.toLowerCase().includes(searchTerm))
            );
            displayUsers(filtered);
        });

        function loadMessages() {
            database.ref('messages').limitToLast(100).once('value', (snapshot) => {
                const messages = snapshot.val();
                allMessages = [];
                if (messages) {
                    Object.keys(messages).forEach(msgId => {
                        allMessages.push({ id: msgId, ...messages[msgId] });
                    });
                }
                allMessages.sort((a, b) => b.timestamp - a.timestamp);
                displayMessages(allMessages);
            });
        }

        function displayMessages(messages) {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '';
            if (messages.length === 0) {
                messageList.innerHTML = '<p style="color: white; text-align: center;">No messages found</p>';
                return;
            }
            messages.forEach(msg => {
                const messageItem = document.createElement('div');
                messageItem.className = 'message-item';
                const time = new Date(msg.timestamp).toLocaleString();
                messageItem.innerHTML = `
                    <div class="message-info">
                        <div class="user-email">${msg.username}</div>
                        <div class="user-details">${msg.message}</div>
                        <div class="user-details">${time}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteMessage('${msg.id}')">üóëÔ∏è Delete</button>
                `;
                messageList.appendChild(messageItem);
            });
        }

        document.getElementById('messageSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allMessages.filter(msg => 
                msg.message.toLowerCase().includes(searchTerm) ||
                msg.username.toLowerCase().includes(searchTerm)
            );
            displayMessages(filtered);
        });

        function deleteUser(uid) {
            if (!confirm('Are you sure you want to delete this user? This will remove their data but not their authentication account.')) return;
            database.ref('users/' + uid).remove()
                .then(() => {
                    alert('User data deleted successfully');
                    loadUsers();
                    loadAnalytics();
                })
                .catch((error) => { alert('Error deleting user: ' + error.message); });
        }

        function banUser(uid, email) {
            if (!confirm(`Are you sure you want to ban ${email}? This will delete all their messages.`)) return;
            database.ref('messages').once('value', (snapshot) => {
                const messages = snapshot.val();
                if (messages) {
                    Object.keys(messages).forEach(msgId => {
                        if (messages[msgId].userId === uid) {
                            database.ref('messages/' + msgId).remove();
                            }
                    });
                }
                alert('User banned and messages deleted');
                loadMessages();
                loadAnalytics();
            });
        }

        function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) return;
            database.ref('messages/' + messageId).remove()
                .then(() => {
                    alert('Message deleted');
                    loadMessages();
                    loadAnalytics();
                })
                .catch((error) => { alert('Error: ' + error.message); });
        }

        function loadBlacklist() {
            database.ref('blacklist').once('value', (snapshot) => {
                const blacklist = snapshot.val();
                const blacklistList = document.getElementById('blacklistList');
                blacklistList.innerHTML = '';
                if (blacklist) {
                    Object.keys(blacklist).forEach(wordId => {
                        const item = document.createElement('div');
                        item.className = 'user-item';
                        item.innerHTML = `
                            <div class="user-info">
                                <div class="user-email">${blacklist[wordId]}</div>
                            </div>
                            <button class="delete-btn" onclick="removeBlacklistWord('${wordId}')">üóëÔ∏è Remove</button>
                        `;
                        blacklistList.appendChild(item);
                    });
                }
            });
        }

        function addBlacklistWord() {
            const word = document.getElementById('newBlacklistWord').value.trim().toLowerCase();
            if (!word) {
                alert('Please enter a word');
                return;
            }
            database.ref('blacklist').push(word)
                .then(() => {
                    alert('Word added to blacklist');
                    document.getElementById('newBlacklistWord').value = '';
                    loadBlacklist();
                });
        }

        function removeBlacklistWord(wordId) {
            database.ref('blacklist/' + wordId).remove()
                .then(() => {
                    alert('Word removed from blacklist');
                    loadBlacklist();
                });
        }

        // Menu toggle
        document.getElementById('userMenuBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('userMenuDropdown').classList.toggle('show');
        });

        document.addEventListener('click', function() {
            document.getElementById('userMenuDropdown').classList.remove('show');
        });

        document.getElementById('logoutLink').addEventListener('click', function() {
            auth.signOut().then(() => {
                alert('Logged out successfully');
                location.reload();
            });
        });
    </script>

    <footer>
        <div class="socials">
            <a href="https://twitter.com/yourusername" target="_blank">Twitter</a>
            <a href="https://discord.gg/yourinvite" target="_blank">Discord</a>
            <a href="https://instagram.com/yourusername" target="_blank">Instagram</a>
            <a href="https://github.com/yourusername" target="_blank">GitHub</a>
        </div>
        <p class="copyright">¬© 2025 MamboHachimi. All rights reserved.</p>
    </footer>
</body>
</html>